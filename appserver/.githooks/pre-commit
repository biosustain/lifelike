#!/bin/sh

# Path from shell to folder containing this file
__dir__="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Runs linting on only files that are staged
staged_files=$(getStaged appserver '\.(py)$')

# Turn debugging on by the flag
if [[ -n $DEBUG_HOOKS ]];
then
  echo "> ðŸ› flake8 version:"
  $DOCKER_COMPOSE_RUN --no-deps appserver flake8 --version
  echo "> ðŸ› mypy version:"
  $DOCKER_COMPOSE_RUN --no-deps appserver mypy --version
  echo "> ðŸ› pycodestyle version:"
  $DOCKER_COMPOSE_RUN --no-deps appserver pycodestyle --version
fi

# shellcheck disable=SC2236
if [[ -n $staged_files ]];
then
   (
    echo "> ðŸŒ½ Running flake8..."
    image_hash=$(docker build -q -f $__dir__/flake8_Dockerfile $__dir__)
    echo ${staged_files} | \
      xargs docker run --rm \
      -v $(pwd)/appserver:/apps \
      $image_hash
  ) && (
    echo "> ðŸ¥§ Running mypy..."
    echo ${staged_files} | xargs $DOCKER_COMPOSE_RUN --no-deps appserver mypy
  ) && (
    echo "> ðŸ Running pycodestyle..."
    echo ${staged_files} | \
      xargs docker run --rm \
      -v $(pwd)/appserver:/data \
      cytopia/pycodestyle:2
  )
else
  echo "> Skipping python files check for appserver..."
fi
