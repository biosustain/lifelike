# local development overrides

version: '3.5'

services:
    pgdatabase:
        command: postgres -c max_wal_size=2GB -c log_statement='all'
        container_name: pg-database
        image: postgres:10.2
        networks:
            - backend
        ports:
            - "5431:5432"
        volumes:
            -  ./postgres/db:/var/lib/postgresql/data

    appserver:
        container_name: n4j-appserver
        command: [
            'bin/wait-for-postgres',
            'bin/wait-for-neo4j',
            'bin/start-dev',
        ]
        build:
            # use different Dockerfile for ci because
            # we change user with USER cmd
            # only ***ARANGO_USERNAME*** has write permission in GITHUB_WORKSPACE
            # which is used by github actions
            context: ./appserver
            dockerfile: Dockerfile.test
        ports:
            - "5000:5000"
        environment:
            - NEO4J_HOST=n4j-database
            - NEO4J_AUTH=neo4j/password
            - FLASK_DEBUG=1
            - FLASK_APP=app
            - FLASK_APP_CONFIG=Development
            - POSTGRES_HOST=pgdatabase
            # Postgres defaults
            - POSTGRES_PORT=5432
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_DB=postgres
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        networks:
            - frontend
            - backend
        volumes:
            - ./appserver:/home/n4j
        depends_on:
            - database
            - pgdatabase
        stdin_open: true
        tty: true

    database:
        container_name: n4j-database
        environment:
            - NEO4J_AUTH=neo4j/password
        image: neo4j:3.5.14
        ports:
            - "7474:7474"
            - "7687:7687"
        networks:
            - backend
        volumes:
            - ./db/data:/data
            - ./db/logs:/logs
            - ./db/plugins:/plugins

networks:
    frontend:
    backend:
