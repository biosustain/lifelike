<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:pro="http://www.liquibase.org/xml/ns/pro"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-3.8.xsd">
  <!--
    Neo4j does not allow the same transaction for changing the scheme and writes.
    So group changeSets together by id="some text-#"
    And separate changeSets grouping by empty new line space
  -->

  <changeSet id="LL-2193-drop-index-association-id-1" author="Binh Vu">
    <comment>Init and See changeset id to group changesets together</comment>
    <sql>DROP INDEX ON :Association(id)</sql>
  </changeSet>
  <changeSet id="LL-2193-drop-index-association-id-2" author="Binh Vu">
    <comment>See changeset id to group changesets together</comment>
    <sql>
      MATCH (n1)-[:HAS_ASSOCIATION]->(a:Association)-[:HAS_ASSOCIATION]->(n2)
      SET a.id = n1.id + '-' + n2.id + '-' + a.type
    </sql>
  </changeSet>
  <changeSet id="LL-2193-drop-index-association-id-3" author="Binh Vu">
    <comment>See changeset id to group changesets together</comment>
    <sql>CREATE CONSTRAINT constraint_association_id ON (n:Association) ASSERT n.id IS UNIQUE</sql>
  </changeSet>

  <!-- ##### -->

  <changeSet id="LL-2193-drop-index-snippet-id-1" author="Binh Vu">
    <comment>See changeset id to group changesets together</comment>
    <sql>DROP INDEX ON :Snippet(id)</sql>
  </changeSet>
  <changeSet id="LL-2193-drop-index-snippet-id-2" author="Binh Vu">
    <comment>See changeset id to group changesets together</comment>
    <sql>
    <!-- this query seems to be crashing neo4j -->
      MATCH (n:Snippet)-[:IN_PUB]-(p)
      SET n.id = p.pmid + '-' + n.sentence_num
    </sql>
  </changeSet>

  <!-- ##### -->

  <changeSet id="LL-2193-data-transforms" author="Binh Vu">
    <comment>
      Set predicts properties, remove snippet properties, merge snippets and remove redundant [IN_PUB] relationship
    </comment>
    <sql>
      MATCH (n:Snippet)-[p:PREDICTS]-(a)
      SET p.entry1_text = n.entry1_text, p.entry2_text = n.entry2_text, p.path = n.path;
      MATCH (n:Snippet)
      REMOVE n.path, n.pmid, n.entry1_text, n.entry1_type, n.entry2_text, n.entry2_type, n.sentence_num;
      <!--
        TODO: need to figure out how to rewrite the apoc.refactor.mergeNodes()
        since liquibase currently does not work with queries that return values (a known bug)

        trying to yield and set a node property so it's not techniqcally returning
        let's see if this works
      -->
      MATCH (n:Snippet) WITH collect(n) AS nodes WHERE size(nodes) > 1
      WITH nodes limit 5000
      CALL apoc.refactor.mergeNodes(nodes, {properties: 'discard', mergeRels:true}) YIELD node
      SET node.liquibase = true;
      MATCH (n:Snippet) WHERE exists(n.liquibase) REMOVE n.liquibase;
    </sql>
  </changeSet>
</databaseChangeLog>
