@use 'sankey';
@import 'variables';
@import '../../utils/nodeColors';

app-sankey-single-lane {
  $active-opacity: 1;
  $darken-link-stroke: 5%;
  $link-lightness: 65%;
  $link-color: hsl(0, 0, $link-lightness);
  $inactive-colour: lighten($link-color, 25%);
  $inactive-opacity: .1;
  $link-left-color: rgb(163, 200, 219);
  $link-saturation: 30%;
  $link-multi-color: hsl(180, $link-saturation, $link-lightness);

  $link-right-color: rgb(255, 226, 149);

  $search-color: sankey.$search-accent-color;

  @mixin link-color($color) {
    fill: $color;
    stroke: darken($color, $darken-link-stroke);
  }

  @keyframes searchBlink {
    50% {
      fill: sankey.$search-accent-color;
    }
  }

  @mixin search-blink {
    animation-duration: 750ms;
    animation-name: searchBlink;
  }

  display: block;
  //touch-action: none;
  //user-select: none;
  height: 100%;

  min-height: 100%;
  overflow: hidden;
  position: relative;
  transform-origin: 0 0;
  width: 100%;

  svg {
    background-color: $window-background;
    height: 100%;
    width: 100%;

    g {
      .nodes {
        shape-rendering: crispEdges;
        z-index: 1;

        g {
          .text-shadow {
            display: none;
            fill: sankey.$node-label-shadow;
            filter: blur(.1em);
            mix-blend-mode: lighten;
            stroke: none;
            transform: scaleY(1.5);
          }

          &[highlighted="false"],
          &[selected="false"] {
            > rect {
              opacity: $inactive-opacity;
            }

            text {
              opacity: $inactive-opacity;
            }
          }

          &:hover,
          &[selected="true"],
          &[highlighted="true"],
          &[transitively-selected="true"] {
            > rect {
              opacity: 100% !important;
            }

            text {
              opacity: $active-opacity;
            }
          }

          &:hover,
          &[selected="true"],
          &[highlighted="true"] {
            > rect {
              opacity: 100% !important;
              stroke: sankey.$selection-accent-color;
              stroke-opacity: 1;
              stroke-width: 3;
            }
          }

          @each $position, $color in $node-colors {
            &[graphRelativePosition=#{$position}] {
              > rect {
                fill: $color;
              }
            }
          }

          rect {
            cursor: move;
            fill: $node-color;
            shape-rendering: crispEdges;
            stroke: $node-border-colour;
          }

          &[highlighted="left"] {
            > rect {
              fill: map-get($node-colors, left);
            }
          }

          &[searched="true"] .text-shadow {
            display: initial;
            fill: opacify(sankey.$active-node-label-shadow, .5);
            filter: none;
            mix-blend-mode: normal;
            stroke: $search-color;
            transform: scaleY(1.5) scaleX(1.1);
            transform-origin: 15px 0;
          }

          &[focused="true"] {
            .text-shadow {
              fill: opacify(sankey.$active-node-label-shadow, .85);
              @include search-blink();
            }

            text {
              fill: $black;
              font-size: 1em;
            }
          }

          &:hover .text-shadow {
            display: initial;
          }

          text {
            font-size: .5em;
            // todo: reenable when performance improves
            //transition: font-size 250ms 250ms, fill 250ms 250ms;
            pointer-events: none;
          }

          &:hover text {
            fill: $black;
            font-size: 1em;
          }
        }
      }

      .links path {
        @include link-color($link-color);

        &.circular {
          stroke-dasharray: 4 4;
        }

        &[highlighted="false"],
        &[selected="false"],
        &[transitively-selected="false"] {
          @include link-color($inactive-colour);
          opacity: $inactive-opacity;
        }

        &[highlighted="true"] {
          @include link-color($link-color);
        }

        &:hover,
        &[transitively-selected="true"],
        &[selected="true"],
        &[highlighted="true"] {
          stroke: sankey.$selection-accent-color;
          stroke-opacity: 1;
          stroke-width: 3;
        }

        &[highlighted="left"] {
          @include link-color($link-left-color);
        }

        &[highlighted="right"] {
          @include link-color($link-right-color);
        }

        &[highlighted="multiple"] {
          @include link-color($link-multi-color);
        }

        &[highlighted="true"],
        &[selectedTrace="true"] {
          &[thickness='0'] {
            stroke: darken($link-color, $darken-link-stroke);
            stroke-width: 3px;
          }
        }

        &[transitively-selected="left"] {
          @include link-color($link-left-color);
        }

        &[transitively-selected="right"] {
          @include link-color($link-right-color);
        }

        &[transitively-selected="multiple"] {
          @include link-color($link-multi-color);
        }

        &[searched="true"] {
          stroke: sankey.$search-accent-color;
        }

        &[focused="true"] {
          fill: sankey.$search-accent-color;
          @include search-blink();
        }
      }
    }
  }
}
