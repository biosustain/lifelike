<div class="position-relative h-100" #modalContainer>
  <ng-container *ngIf="(loadTask.status$ | async) as status">
    <app-module-progress *ngIf="status.running" class="position-absolute w-100 h-100 bg-white"
                         style="z-index: 2">
      Loading map...
    </app-module-progress>

    <app-module-error *ngIf="status.failedErrorShown"
                      class="position-absolute w-100 h-100 bg-white p-4"
                      style="z-index: 2" [error]="status.error">
      <a appLink="/projects">Go to Projects <i class="fa fa-fw fa-arrow-right"></i></a>
    </app-module-error>
  </ng-container>

  <div class="position-absolute w-100 h-100 d-flex flex-column" style="z-index: 0">
    <div class="module">
      <div class="module-header" *ngIf="map">
        <!-- Breadcrumbs -->
        <div class="module-breadcrumb-bar mb-1" *ngIf="map">
          <app-object-path [object]="map.parent" [newTab]="true"></app-object-path>
        </div>

        <div class="d-flex flex-wrap align-items-center">
          <div class="module-title-bar mr-4">
            <button type="button" class="module-title-bar-back mr-2" (click)="goToReturnUrl()"
                    *ngIf="returnUrl">
              <i class="fa fa-fw fa-arrow-left"></i>
            </button>
            <h1 class="module-title text-truncate" draggable="true"
                (dragstart)="this.dragStarted($event)">
              {{ map?.label }}
            </h1>

            <div ngbDropdown class="d-inline-block ml-1" container="body">
              <a href="#" class="dropdown-no-arrow" ngbDropdownToggle
                 (click)="$event.preventDefault()">
                <i class="fas fa-chevron-down fa-fw text-icon"></i>
              </a>
              <div ngbDropdownMenu>
                <app-object-menu [object]="map" [forEditing]="true"
                                 [showOpen]="false" [showDelete]="false"
                                 [showRestore]="true" (objectRestore)="restore($event)"
                                 (objectUpdate)="emitModuleProperties()">
                </app-object-menu>
              </div>
            </div>

            <div *ngIf="unsavedChanges$.value" class="ml-1">
                <span class="badge badge-danger badge-pill ml-1"
                      ngbTooltip="Has unsaved changes" container="body">
                  <i class="fa fa-pencil-alt"></i>
                </span>
            </div>

            <div class="btn-group ml-2">
              <button type="button" class="btn btn-secondary"
                      ngbTooltip="Save" placement="bottom" container="body" (click)="save()">
                <i class="fa fa-fw fa-save"></i>
              </button>
            </div>
          </div>

          <div class="module-toolbar d-flex align-items-center ml-auto">
            <div class="btn-group mr-2">
              <button type="button" class="btn btn-secondary"
                      ngbTooltip="Undo" placement="bottom" container="body"
                      (click)="undo()"
                      [disabled]="!graphCanvas || !graphCanvas.canUndo()">
                <i class="fa fa-fw fa-undo"></i>
              </button>
              <button type="button" class="btn btn-secondary"
                      ngbTooltip="Redo" placement="bottom" container="body"
                      (click)="redo()"
                      [disabled]="!graphCanvas || !graphCanvas.canRedo()">
                <i class="fa fa-fw fa-redo"></i>
              </button>
            </div>

            <div class="ml-auto d-flex">
              <div class="btn-group mr-2">
                <button type="button" class="btn btn-secondary" container="body"
                        ngbTooltip="Fit Map to Window" placement="bottom"
                        (click)="zoomToFit()">
                  <i class="fas fa-expand-arrows-alt"></i>
                </button>
              </div>

              <app-search-control [(ngModel)]="entitySearchTerm" (ngModelChange)="search()"
                                  [resultIndex]="entitySearchListIdx"
                                  [resultCount]="entitySearchList.length"
                                  (previous)="previous()" (next)="next()">
              </app-search-control>
            </div>
          </div>
        </div>
      </div>

      <div class="position-relative overflow-hidden flex-fill">
        <ng-container *ngIf="map && (lockAcquired === false || !lockCheckingActive)">
          <ng-container *ngIf="locks.length && lockCheckingActive; else locksReleased">
            <div class="lock-panel alert alert-danger">
              <div>
                <strong>Warning:</strong> This file is being edited by another user and saving will
                erase the other user's changes.
              </div>

              <ul class="m-0">
                <li *ngFor="let lock of locks">
                  {{ lock.user.firstName }} {{ lock.user.lastName }}
                </li>
              </ul>
            </div>
          </ng-container>
          <ng-template #locksReleased>
            <div class="lock-panel alert alert-warning">
              <div>
                Please reload to get the latest changes.
              </div>

              <div class="mt-2">
                <button type="button" class="btn btn-primary" (click)="reload()">
                  Reload
                </button>
              </div>
            </div>
          </ng-template>
        </ng-container>

        <as-split unit="pixel"
                  direction="horizontal"
                  [gutterSize]="2">
          <as-split-area [order]="0" class="overflow-hidden">
            <div class="graph-container">
              <canvas #canvas class="graph-view" [class.drop-target]="dropTargeted"></canvas>
            </div>
          </as-split-area>
          <as-split-area size="250"
                         [order]="1" #infoPanelSidebar>
            <ng-container
              *ngIf="(graphCanvas?.selection.changeObservable | async) as selected; else graphInfo">
              <div class="info-panel" *ngIf="selected[0].length === 1; else graphInfo">
                <app-info-panel [infoPanel]="infoPanel" [selected]="selected[0][0]"
                                (actionCreated)="graphCanvas.execute($event)">
                </app-info-panel>
              </div>
            </ng-container>

            <ng-template #graphInfo>
              <ng-container *ngIf="graphCanvas">
                <div class="d-flex flex-column h-100">
                  <ul ngbNav #nav="ngbNav" [(activeId)]="activeTab"
                      class="nav-tabs nav-sidebar-tabs">
                    <li ngbNavItem="graph">
                      <a ngbNavLink>Graph</a>
                      <ng-template ngbNavContent>
                        <div class="module-body">
                          <div class="row align-items-center mb-0">
                            <div class="col-sm-6">Node Count:</div>
                            <div class="col-sm-6 text-right">
                              {{ graphCanvas.nodes.length | number }}
                            </div>
                          </div>

                          <div class="row align-items-center">
                            <div class="col-sm-6">Edge Count:</div>
                            <div class="col-sm-6 text-right">
                              {{ graphCanvas.edges.length | number }}
                            </div>
                          </div>
                        </div>
                      </ng-template>
                    </li>
                  </ul>

                  <div [ngbNavOutlet]="nav" class="flex-fill overflow-auto"></div>
                </div>
              </ng-container>
            </ng-template>
          </as-split-area>
        </as-split>
      </div>
    </div>

    <div>
      <div>
        <div class="palette-panel">
          <app-collapsible-window title="Palette" [reversed]="true" class="flex-fill">
            <div class="window-body">
              <app-palette></app-palette>
            </div>
          </app-collapsible-window>
        </div>
      </div>
    </div>
  </div>
</div>
