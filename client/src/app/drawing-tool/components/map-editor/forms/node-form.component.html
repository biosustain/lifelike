<div class="d-flex flex-column h-100">
  <ul #nav="ngbNav" [(activeId)]="infoPanel.activeTab" class="nav-tabs nav-sidebar-tabs" ngbNav>
    <li ngbNavItem="properties">
      <a ngbNavLink>Properties</a>
      <ng-template ngbNavContent>
        <div class="form-group">
          <label for="label"> Node Label: </label>
          <input
            #displayName
            (change)="doSave()"
            [(ngModel)]="node.display_name"
            class="form-control map-editor-initial-focus"
            id="label"
            maxlength="2000"
          />
        </div>

        <div class="form-group">
          <label for="detail">Detail:</label>
          <div
            (click)="textArea.focus()"
            [attr.data-replicated-value]="node.data.detail"
            class="form-control textarea-grow-wrap"
          >
            <textarea
              #textArea
              (change)="doSave()"
              [(ngModel)]="node.data.detail"
              cdkAutosizeMinRows="2"
              cdkTextareaAutosize
              id="detail"
              maxlength="5000"
            ></textarea>
          </div>
        </div>

        <div *ngIf="mayShowDetailText()" class="form-group">
          <div class="custom-control custom-checkbox">
            <input
              (change)="doSave()"
              [(ngModel)]="node.style.showDetail"
              class="custom-control-input"
              id="show-detail"
              type="checkbox"
              value="1"
            />
            <label class="custom-control-label" for="show-detail">
              Show detail text instead of the label
            </label>
          </div>
        </div>

        <div class="form-group mb-4">
          <label container="body" for="type" ngbTooltip="Node type"> Type: </label>
          <div class="d-flex flex-column flex-fill">
            <select
              (change)="doSave()"
              (ngModelChange)="handleTypeChange()"
              [(ngModel)]="node.label"
              [disabled]="fixedType"
              class="custom-select w-100"
              id="type"
            >
              <option *ngFor="let choice of nodeTypeChoices" [value]="choice.label">
                {{ choice.label | titlecase }}
              </option>
            </select>
            <div *ngIf="nodeSubtypeChoices.length" class="mt-2">
              <label container="body" for="subtype" ngbTooltip="Node subtype"> Type: </label>
              <select
                (change)="doSave()"
                [(ngModel)]="node.data.subtype"
                class="custom-select flex-fill"
                id="subtype"
              >
                <option *ngFor="let choice of nodeSubtypeChoices" [value]="choice">
                  {{ choice | titlecase }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <app-links-panel
            (ngModelChange)="doSave()"
            [(ngModel)]="node.data.sources"
            fontAwesomeIcon="far fa-book"
            singularTitle="Source"
            title="Sources"
          ></app-links-panel>
        </div>

        <div class="mb-4">
          <app-links-panel
            (ngModelChange)="doSave()"
            [(ngModel)]="node.data.hyperlinks"
            singularTitle="Hyperlink"
            title="Hyperlinks"
          ></app-links-panel>
        </div>

        <ng-container *ngIf="!overflow" [ngTemplateOutlet]="search"></ng-container>
        <ng-container *ngIf="overflow" [ngTemplateOutlet]="delete"></ng-container>
      </ng-template>
    </li>
    <li *ngIf="overflow" ngbNavItem="search">
      <a ngbNavLink>Search</a>
      <ng-template ngbNavContent>
        <ng-container [ngTemplateOutlet]="search"> </ng-container>
      </ng-template>
    </li>
    <li ngbNavItem="style">
      <a ngbNavLink>Style</a>
      <ng-template ngbNavContent>
        <fieldset class="fieldset-properties">
          <legend>Label Style</legend>

          <div class="form-group d-flex align-items-center">
            <label [for]="fontSize.uid" class="my-0 mr-2" container="body" ngbTooltip="Font size">
              <i class="fa fa-fw fa-text-height"></i>
            </label>
            <app-percent-input
              #fontSize="uid"
              #model="ngModel"
              (change)="model.valid && doSave()"
              (ngModelChange)="model.valid && (node.style.fontSizeScale = $event)"
              [max]="1000"
              [min]="20"
              [ngModel]="node.style.fontSizeScale || 1"
              [step]="20"
              appAutoGrow
              appUid
              class="mr-1"
            ></app-percent-input>
          </div>

          <div class="form-group d-flex align-items-center">
            <label class="my-0 mr-2" container="body" ngbTooltip="Text color">
              <i class="fa fa-fw fa-brush"></i>
            </label>
            <app-color-chooser-component
              (colorChange)="doSave()"
              [(color)]="node.style.fillColor"
              [palette]="paletteChoices"
              emptyLabel="Default"
              id="fill-color"
            ></app-color-chooser-component>
          </div>

          <div class="form-group d-flex align-items-center">
            <label class="my-0 mr-2" container="body" ngbTooltip="Background color">
              <i class="fa fa-fw fa-fill"></i>
            </label>
            <app-color-chooser-component
              (colorChange)="doSave()"
              [(color)]="node.style.bgColor"
              [palette]="bgPaletteChoices"
              emptyLabel="Default"
              id="bg-color"
            ></app-color-chooser-component>
          </div>
        </fieldset>

        <fieldset class="fieldset-properties mt-4">
          <legend>Border Style</legend>

          <div class="form-group d-flex align-items-center">
            <label class="my-0 mr-2" container="body" for="stroke-color" ngbTooltip="Border color">
              <i class="fa fa-fw fa-fill"></i>
            </label>
            <app-color-chooser-component
              (colorChange)="doSave()"
              [(color)]="node.style.strokeColor"
              [palette]="paletteChoices"
              emptyLabel="Default"
              id="stroke-color"
            ></app-color-chooser-component>
          </div>

          <div class="form-group d-flex align-items-center">
            <label class="my-0 mr-2" container="body" for="line-type" ngbTooltip="Border line type">
              <i class="fa fa-fw fa-border-style"></i>
            </label>
            <select
              (change)="doSave()"
              [(ngModel)]="node.style.lineType"
              class="custom-select"
              id="line-type"
            >
              <option *ngFor="let choice of lineTypeChoices" [value]="choice[0]">
                {{ choice[1].name }}
              </option>
            </select>
          </div>

          <div class="form-group d-flex align-items-center">
            <label
              [for]="lineWidthScale.uid"
              class="my-0 mr-2"
              container="body"
              ngbTooltip="Border line thickness"
            >
              <i class="fa fa-fw fa-window-minimize"></i>
            </label>
            <app-percent-input
              #lineWidthScale="uid"
              #model="ngModel"
              (change)="model.valid && doSave()"
              (ngModelChange)="model.valid && (node.style.lineWidthScale = $event)"
              [max]="1000"
              [min]="20"
              [ngModel]="node.style.lineWidthScale || 1"
              [step]="20"
              appAutoGrow
              appUid
              class="mr-1"
            ></app-percent-input>
          </div>
        </fieldset>
        <ng-container [ngTemplateOutlet]="delete"></ng-container>
      </ng-template>
    </li>
  </ul>
  <div #scrollWrapper class="overflow-auto h-100">
    <div class="module-body">
      <div [ngbNavOutlet]="nav"></div>
    </div>
  </div>
</div>

<ng-template #search>
  <fieldset
    *ngIf="(node.display_name != null && node.display_name.length) || node.data?.search"
    class="fieldset-properties mb-4"
  >
    <legend>Search Internal <i class="fas fa-external-link-alt ml-1"></i></legend>

    <ul class="list-unstyled m-0">
      <li class="text-truncate">
        <div (click)="searchMapNodeInVisualizer(node)" class="btn btn-link p-0">
          Knowledge Graph
        </div>
      </li>
      <li class="text-truncate">
        <div (click)="searchMapNodeInContent(node, '')" class="btn btn-link p-0">File Content</div>
      </li>
      <li class="text-truncate">
        <div (click)="searchMapNodeInContent(node, 'map')" class="btn btn-link p-0">
          Map Content
        </div>
      </li>
    </ul>
  </fieldset>
  <fieldset
    *ngIf="(node.display_name != null && node.display_name.length) || node.data?.search"
    class="fieldset-properties mb-4"
  >
    <legend>Search External <i class="fas fa-external-link-alt ml-1"></i></legend>
    <app-quick-search [query]="node.display_name" [links]="node.data?.search"></app-quick-search>
  </fieldset>
  <ng-container [ngTemplateOutlet]="delete"></ng-container>
</ng-template>

<ng-template #delete>
  <div class="mb-4">
    <button (click)="doDelete()" type="button" class="btn btn-danger btn-block">Delete</button>
  </div>
</ng-template>
