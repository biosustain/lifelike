<div class="position-relative h-100">
  <ng-container *ngIf="(loadTask.status$ | async) as status">
    <app-module-progress *ngIf="status.running" class="position-absolute w-100 h-100 bg-white"
                         style="z-index: 2">
      Loading map...
    </app-module-progress>

    <app-module-error *ngIf="status.failedErrorShown" class="position-absolute w-100 h-100 bg-white p-4"
                      style="z-index: 2" [error]="status.error">
      <a appLink="/projects">Go to Projects <i class="fa fa-fw fa-arrow-right"></i></a>
    </app-module-error>
  </ng-container>

  <div class="position-absolute w-100 h-100 d-flex flex-column" style="z-index: 0">
    <div class="module">
      <div class="module-header">
        <div class="d-flex flex-wrap">
          <div class="module-title-bar">
            <button type="button" class="module-title-bar-back mr-2" (click)="goToReturnUrl()" *ngIf="returnUrl">
              <i class="fa fa-fw fa-arrow-left"></i>
            </button>
            <h1 class="module-title text-truncate" draggable="true" (dragstart)="this.dragStarted($event)">
              {{ map?.label }}
            </h1>

            <div class="btn-group ml-2" *ngIf="hasEditPermission">
              <button type="button" class="btn btn-secondary"
                      [appLink]="['/projects', this.locator.projectName, 'maps', this.locator.hashId, 'edit']"
                      [newTab]="true">
                <i class="fa fa-fw fa-pencil-alt"></i> Edit
              </button>
            </div>
          </div>

          <div class="module-toolbar d-flex align-items-center ml-auto">
            <div class="btn-group mr-2">
              <button type="button" class="btn btn-secondary" container="body"
                      ngbTooltip="Fit Map to Window" placement="bottom"
                      (click)="zoomToFit()">
                <i class="fas fa-expand-arrows-alt"></i>
              </button>
            </div>

            <div class="btn-group">
              <button type="button" class="btn btn-secondary"
                      (click)="displayShareDialog()">
                <i class="fa fa-fw fa-share-square"></i> Share
              </button>
            </div>

            <div class="ml-2" style="width: 300px;">
              <app-search-control [(ngModel)]="entitySearchTerm" (ngModelChange)="search()"
                                  [resultIndex]="entitySearchListIdx" [resultCount]="entitySearchList.length"
                                  (previous)="previous()" (next)="next()">
              </app-search-control>
            </div>
          </div>
        </div>

        <div class="text-warning mt-2">
          You are currently in view-only mode.
        </div>

      </div>

      <div class="flex-fill position-relative overflow-hidden" style="z-index: 0">
        <canvas #canvas class="graph-view"></canvas>

        <ng-container *ngIf="(loadTask.status$ | async) as status">
          <div class="detail-overlay">
            <app-collapsible-window title="Information" class="flex-fill" [sideCollapse]="true">
              <div class="window-body">
                <div class="detail-overlay-properties text-muted">
                  <div class="text-truncate">
                    By {{map?.author}}
                  </div>
                  <div class="text-truncate">
                    Modified {{map?.modified_date | friendlyDateStr}}
                  </div>
                </div>
                <div class="detail-overlay-description mt-2">
                  {{map?.description}}
                </div>
              </div>
            </app-collapsible-window>
          </div>

          <ng-container *ngIf="(graphCanvas?.selection.changeObservable | async) as selected">
            <div class="info-panel" *ngIf="selected[0].length === 1">
              <app-info-view-panel [selected]="selected[0][0]">
              </app-info-view-panel>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</div>
