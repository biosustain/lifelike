<div class="module" *ngIf="(loadTask.status$ | async) as status">
    <app-module-progress *ngIf="status.running">
         Downloading file... {{ status.retryInProgressShown ? 'Retrying...' : '' }}
    </app-module-progress>

    <app-module-error *ngIf="status.failedErrorShown" [error]="status.error">
        <a appLink="/projects">Go to Projects <i class="fa fa-fw fa-arrow-right"></i></a>
    </app-module-error>

    <ng-container *ngIf="status.resultsShown">
        <app-module-header [object]="object"
                           [dragTitleData$]="dragTitleData$">
              <app-module-menu *ngIf="object" [object]="object" [forEditing]="true"
                               [showOpen]="false" [showDelete]="false"
                               (objectRefresh)="requestRefresh()">
              </app-module-menu>
            <div class="btn-group ml-auto mr-1 d-flex align-items-stretch">
                <div ngbDropdown container="body" class="d-flex align-items-stretch btn-group">
                    <button type="button" class="btn btn-secondary btn-sm" ngbDropdownToggle>
                        <i class="fa fa-fw fa-search"></i>
                    </button>
                    <div ngbDropdownMenu class="dropdown-menu">
                        <button class="dropdown-item" (click)="zoomActualSize()">
                            Actual Size
                        </button>
                        <button class="dropdown-item" (click)="fitToPage()">
                            Fit to Page
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary"
                        [disabled]="!ready" (click)="zoomOut()" ngbTooltip="Zoom out"
                        placement="bottom">
                    <i class="fa fa-fw fa-search-minus"></i>
                </button>
                <button type="button" class="btn btn-secondary"
                        [disabled]="!ready" (click)="zoomIn()" ngbTooltip="Zoom in"
                        placement="bottom">
                    <i class="fa fa-fw fa-search-plus"></i>
                </button>
            </div>
            <div
              *ngIf="highlightController$ | async as highlightController"
              class="d-flex mr-1"
              style="min-width: 150px"
            >
                <app-result-control
                        *ngIf="highlightController.type === 'annotation'; else textSearchControl"
                        [value]="highlightController.value"
                        [annotationColor]="highlightController.color"
                        [resultIndex]="highlightController.index"
                        [resultCount]="highlightController.total"
                        (previous)="highlightController.prev()"
                        (next)="highlightController.next()"
                        (enterPress)="highlightController.next()"
                        (valueClear)="highlightController.changeValue(null)">
                </app-result-control>
                <ng-template #textSearchControl>
                    <app-search-control [ngModel]="highlightController.value"
                                        (ngModelChange)="highlightController.changeValue($event)"
                                        [searching]="highlightController.searching"
                                        [resultIndex]="highlightController.index"
                                        [resultCount]="highlightController.total"
                                        (previous)="highlightController.prev()"
                                        (next)="highlightController.next()"
                                        #searchControl>
                    </app-search-control>
                </ng-template>
            </div>
            <div class="btn-group" role="group">
                <div ngbDropdown class="d-inline-block btn-group" #dropdown placement="bottom-right" container="body">
                    <button class="btn btn-secondary" [id]="id + '-filters-dropdown'" ngbDropdownToggle>
                        <i class="fa fa-fw fa-filter"></i>
                    </button>
                    <div ngbDropdownMenu
                         [attr.aria-labelledby]="id + '-filters-dropdown'"
                         [style.width]="'220px'"
                         class="dropdown-body dropdown-menu dropdown-menu-right">
                      <div class="mb-2">
                        <ng-template #hideAll>
                          <button class="btn btn-outline-secondary btn-block"
                                  (click)="setAllEntityTypesVisibility(false)">
                            Hide All
                          </button>
                        </ng-template>
                        <button *ngIf="entityTypeVisibilityMapContainsUnchecked$ | async else hideAll"
                                class="btn btn-outline-secondary btn-block"
                                (click)="setAllEntityTypesVisibility(true)">
                          Show All
                        </button>
                      </div>

                      <div
                        *ngFor="let entityTypeEntry of sortedEntityTypeEntriesVisibilityMap$ | async | keyvalue"
                        [style.opacity]="entityTypeEntry.key.annotations.length ? '' : '0.2'">
                        <div class="custom-control custom-checkbox">
                          <input class="custom-control-input" type="checkbox"
                                 [id]="id + 'filter-' + entityTypeEntry.key.type.id"
                                 value="1"
                                 [checked]="entityTypeEntry.value"
                                 (change)="changeEntityTypeVisibility(entityTypeEntry.key.type.id, $event.target.checked)">
                          <label class="custom-control-label"
                                 [for]="id + 'filter-' + entityTypeEntry.key.type.id">
                  <span class="entity-type-legend"
                        [ngStyle]="{background: entityTypeEntry.key.type.color}">
                </span> {{entityTypeEntry.key.type.name}} <span
                            *ngIf="!!entityTypeEntry.key.annotations.length">
                  ({{entityTypeEntry.key.annotations.length}})
                </span>
                          </label>
                        </div>
                      </div>

                      <div class="mt-2">
                        <div class="custom-control custom-checkbox">
                          <input type="checkbox" [(ngModel)]="showExcludedAnnotations"
                                 class="custom-control-input" [id]="id + '-showExcludedAnnotations'">
                          <label class="custom-control-label" [for]="id + '-showExcludedAnnotations'">Show
                            excluded
                            annotations</label>
                        </div>
                      </div>

                      <div class="mt-2">
                        <button class="btn btn-secondary btn-block" (click)="closeFilterPopup()">
                          Done
                        </button>
                      </div>
                    </div>
                </div>

            <button type="button" class="btn btn-secondary"
                    [disabled]="!ready"
                     [appLink]="[
                            '/file-navigator',
                            encodeURIComponent(this.object.project.name),
                            this.object.hashId
                        ]"
                      [parentAddress]="[
                            '/projects',
                            encodeURIComponent(this.object.project.name),
                            'files',
                            this.object.hashId
                      ]"
                      [newTab]="true" [sideBySide]="true" [forceWorkbench]="true" [openParentFirst]="true"
                    ngbTooltip="File Navigator" placement="bottom">
              <i class="fas fa-fw fa-compass"></i>
            </button>
        <div class="flex-fill overflow-hidden position-relative d-flex h-100">
            <div *ngIf="isPendingPostLoadAction()"
                 class="pending-scroll-box-container">
                <div class="pending-scroll-box floating-toolbar d-flex align-items-center flex-column">
                    <div>
                        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
                    </div>
              </div>
            </div>
        </div>
    </div>
    </app-module-header>
        <div class="flex-fill overflow-hidden position-relative d-flex h-100">
            <div *ngIf="isPendingPostLoadAction()"
                 class="pending-scroll-box-container">
                <div class="pending-scroll-box floating-toolbar d-flex align-items-center flex-column">
                    <div>
                        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
                    </div>
                    <div class="mt-2">
                        <ng-container *ngIf="isPendingScroll(); else pendingJump">
                            Finding place<br>in document...
                        </ng-container>
                        <ng-template #pendingJump>
                            <ng-container *ngIf="isPendingJump(); else pendingHighlight">
                                Finding snippet<br>in document...
                            </ng-container>
                        </ng-template>
                        <ng-template #pendingHighlight>
                            Finding entity<br>in document...
                        </ng-template>
                    </div>
                </div>
            </div>
            <div class="flex-fill overflow-auto pdf-viewer-lib-wrapper" [id]="id + '-pdf-viewer-lib-wrapper'">
                <div *ngIf="ready">
                    <!-- PDF Viewer -->
                    <app-lib-pdf-viewer-lib
                            tabindex=0
                            id='pdf-viewer'
                            appPdfViewer
                            [pdfSrc]="pdfData"
                            [goToPosition$]="goToPosition$"
                            (goToPositionVisit)="goToPositionVisit($event)"
                            [showExcludedAnnotations]="showExcludedAnnotations"
                            [entityTypeVisibilityMap]="entityTypeVisibilityMap$ | async"
                            (annotationDragStart)="addAnnotationDragData($event)"
                            (loadCompleted)="loadCompleted($event)"
                    >
                    </app-lib-pdf-viewer-lib>
                </div>
            </div>
        </div>
    </ng-container>
</div>
