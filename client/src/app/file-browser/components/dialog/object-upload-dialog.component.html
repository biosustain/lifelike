<form (ngSubmit)="submit()" [formGroup]="form">
  <app-modal-header (cancel)="cancel()">
    {{ title }}
  </app-modal-header>

  <app-modal-body>
    <app-form-input-feedback [control]="form" [formLevel]="true"></app-form-input-feedback>

    <ng-container *ngIf="promptUpload">
      <ul
        #nav="ngbNav"
        (navChange)="activeTabChanged($event)"
        [activeId]="form.get('contentSource').value"
        class="nav-tabs"
        ngbNav
      >
        <li ngbNavItem="contentValue">
          <a ngbNavLink>From Device</a>
          <ng-template ngbNavContent>
            <app-form-row
              [control]="form.get('contentValue')"
              for="content-value"
              label="Add files"
            >
              <div class="d-flex align-items-center text-truncate">
                <button (click)="showFileDialog()" class="btn btn-secondary mr-2" type="button">
                  Browse...
                </button>
              </div>
              <input
                #fileInput
                (change)="fileChanged($event)"
                class="d-none"
                id="content-value"
                multiple
                type="file"
              />
            </app-form-row>
            <table *ngIf="fileList.length" class="table" style="table-layout: fixed">
              <caption *ngIf="fileList.length > 1" class="pa2-l">
                Click on the row to inspect and edit properties.
              </caption>
              <caption *ngIf="fileList.length >= maxFileCount" class="alert-danger pa2-l">
                You can only upload
                {{
                  maxFileCount
                }}
                files at once.
              </caption>
              <colgroup>
                <col style="width: 50%" />
              </colgroup>
              <thead>
                <tr></tr>
                <tr>
                  <th class="d-none d-lg-table-cell">Filename</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  (appTabSelectable)="changeSelectedFile(index)"
                  *ngFor="let file of fileList; let index = index"
                  [class.bg-highlight]="index === selectedFileIndex"
                >
                  <td class="align-middle text-truncate mw-100">
                    {{ file.filename }}
                  </td>
                  <td>
                    <i
                      *ngIf="file.hasErrors"
                      class="fa fa-lg fa-exclamation-circle alert-danger"
                      ngbTooltip="Invalid input(s)!"
                    ></i>
                  </td>
                  <td class="text-right">
                    <i (click)="handleDelete(index)" class="fa fa-trash-alt"></i>
                  </td>
                </tr>
              </tbody>
            </table>
          </ng-template>
        </li>
        <li ngbNavItem="contentUrl">
          <a ngbNavLink>From URL</a>
          <ng-template ngbNavContent>
            <app-form-row [control]="form.get('contentUrl')" for="content-url" label="URL">
              <input
                (change)="urlChanged($event)"
                [appFormInput]="form.get('contentUrl')"
                formControlName="contentUrl"
                id="content-url"
                placeholder="https://www.example.com/file.pdf"
                type="text"
              />
            </app-form-row>
          </ng-template>
        </li>
      </ul>

      <div [ngbNavOutlet]="nav" class="mt-4"></div>
    </ng-container>

    <app-form-row
      *ngIf="promptParent"
      [control]="form.get('parent')"
      [label]="parentLabel"
      for="parent"
    >
      <div class="d-flex align-items-center text-truncate">
        <button (click)="showParentDialog()" class="btn btn-secondary mr-2" type="button">
          Browse...
        </button>
        <div *ngIf="form.get('parent').value != null; else noParentChosen" class="text-truncate">
          <i class="fa fa-fw fa-folder text-icon"></i>
          {{ form.get("parent").value.effectiveName }}
        </div>
        <ng-template #noParentChosen> </ng-template>
      </div>
    </app-form-row>

    <app-form-row [control]="form.get('filename')" for="filename" label="Filename">
      <input
        [appFormInput]="form.get('filename')"
        [autoSelect]="true"
        appAutoFocus
        formControlName="filename"
        id="filename"
        type="text"
      />
    </app-form-row>

    <app-form-row [control]="form.get('description')" for="description" label="Description">
      <textarea
        [appFormInput]="form.get('description')"
        formControlName="description"
        id="description"
        rows="10"
      ></textarea>
    </app-form-row>

    <app-form-row *ngIf="!object.isDirectory" [control]="form.get('public')">
      <div class="custom-control custom-checkbox">
        <input class="custom-control-input" formControlName="public" id="public" type="checkbox" />
        <label class="custom-control-label" for="public">Publicly share with the community</label>
      </div>
    </app-form-row>

    <ng-container *ngIf="possiblyAnnotatable">
      <fieldset class="fieldset-properties mt-4">
        <legend>Annotation Options</legend>
        <app-form-row
          *ngIf="object.promptOrganism"
          label="Organism"
          ngbTooltip="If you know the specific organism strain related to the paper, you may optionally search for it by name here."
        >
          <app-organism-autocomplete
            (organismPicked)="organismChanged($event)"
            [organismTaxId]="form.get('organism').value ? form.get('organism').value.tax_id : null"
            formId="organism"
          ></app-organism-autocomplete>
        </app-form-row>

        <app-form-row>
          <ngb-accordion>
            <ngb-panel title="Annotation Configurations">
              <ng-template ngbPanelContent>
                <app-annotation-config-table
                  [fileType]="object.mimeType"
                  [form]="form.get('annotationConfigs')"
                  [headers]="annotationMethods"
                  [models]="annotationModels"
                ></app-annotation-config-table>
              </ng-template>
            </ngb-panel>
          </ngb-accordion>
        </app-form-row>
      </fieldset>
    </ng-container>
  </app-modal-body>

  <app-modal-footer>
    <button type="button" class="btn btn-secondary mr-2" (click)="cancel()">Cancel</button>
    <button type="submit" class="btn btn-primary" [disabled]="form.invalid || invalidInputs">
      Save
    </button>
  </app-modal-footer>
</form>
