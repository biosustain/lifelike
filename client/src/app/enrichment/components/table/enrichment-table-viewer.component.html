<div
  *ngIf="{
    object: object$ | addStatus | async,
    document: document$ | async,
    table: table$ | addStatus | async
  } as result"
  class="module"
>
  <app-module-error *ngIf="result.object.error" [error]="result.object.error"> </app-module-error>
  <app-module-progress *ngIf="result.object.loading">
    Loading enrichment table...
  </app-module-progress>

  <ng-container *ngIf="result.object.value">
    <app-module-header [dragTitleData$]="dragTitleData$" [object]="result.object.value">
      <app-module-menu
        (objectRestore)="restore($event)"
        (objectUpdate)="objectUpdate()"
        [forEditing]="true"
        [object]="result.object.value"
        [showDelete]="false"
        [showOpen]="false"
        [showRestore]="true"
      >
      </app-module-menu>
      <div *ngIf="queuedChanges$.value">
        <span
          class="badge badge-danger badge-pill ml-1"
          container="body"
          ngbTooltip="Has unsaved changes"
        >
          <i class="fa fa-pencil-alt"></i>
        </span>
      </div>

      <!-- Decided to remove this for now, may bring back in the future. -->
      <!-- <div class="btn-group ml-2">
        <button type="button" class="btn btn-secondary"
                ngbTooltip="Save" placement="bottom" container="body" (click)="save()"
                [disabled]="!result.object.value.privileges.writable">
          <i class="fa fa-fw fa-save"></i>
        </button>
      </div> -->

      <div class="btn-group mx-1">
        <button
          (click)="openEnrichmentTableEditDialog(result.object.value, result.document)"
          [disabled]="!result.document || !result.object.value.privileges.writable"
          class="btn btn-secondary"
        >
          <i class="fas fa-fw fa-dna"></i> Parameters
        </button>
        <button
          (click)="openOrderDialog()"
          [disabled]="!result.document || !result.object.value.privileges.writable"
          class="btn btn-secondary"
        >
          <i class="fas fa-fw fa-sort"></i> Columns
        </button>
      </div>

      <div class="btn-group">
        <button (click)="refreshData()" [disabled]="!result.document" class="btn btn-secondary">
          <i class="fas fa-fw fa-sync"></i> Refresh
        </button>
      </div>

      <div class="btn-group ml-auto">
        <button
          [appLink]="[
            '/enrichment-visualisation',
            result.object.value.project.name,
            result.object.value.hashId
          ]"
          [forceWorkbench]="true"
          [newTab]="true"
          [openParentFirst]="true"
          [parentAddress]="[
            '/projects',
            result.object.value.project.name,
            'enrichment-table',
            result.object.value.hashId
          ]"
          [sideBySide]="true"
          class="btn btn-secondary"
        >
          <i class="fas fa-fw fa-chart-bar"></i> Statistical Enrichment
        </button>
        <button
          [appLink]="[
            '/file-navigator',
            result.object.value.project.name,
            result.object.value.hashId
          ]"
          [forceWorkbench]="true"
          [newTab]="true"
          [openParentFirst]="true"
          [parentAddress]="[
            '/projects',
            result.object.value.project.name,
            'enrichment-table',
            result.object.value.hashId
          ]"
          [sideBySide]="true"
          class="btn btn-secondary"
          ngbTooltip="File Navigator"
          placement="bottom"
        >
          <i class="fas fa-fw fa-compass"></i>
        </button>
      </div>

      <div class="ml-auto">
        <ng-container *ngIf="annotation.id; else textSearchControl">
          <app-result-control
            (enterPress)="findController.next()"
            (next)="findController.next()"
            (previous)="findController.previous()"
            (valueClear)="switchToTextFind()"
            [annotationColor]="annotation.color"
            [resultCount]="findController.getResultCount()"
            [resultIndex]="findController.getResultIndex()"
            [value]="annotation.text"
          >
          </app-result-control>
        </ng-container>
        <ng-template #textSearchControl>
          <app-search-control
            (next)="findController.next()"
            (ngModelChange)="findController.nextOrStart()"
            (previous)="findController.previous()"
            (valueClear)="findController.stop()"
            [(ngModel)]="findController.query"
            [resultCount]="findController.getResultCount()"
            [resultIndex]="findController.getResultIndex()"
          >
          </app-search-control>
        </ng-template>
      </div>
    </app-module-header>

    <div *ngIf="result.document?.duplicateGenes?.length" class="text-warning mt-2">
      Duplicate gene names removed from table: {{ result.document?.duplicateGenes.join(", ") }}
    </div>

    <app-module-error
      *ngIf="result.table.error"
      [error]="result.object.error"
      class="module-body flex-fill"
    >
    </app-module-error>

    <app-module-progress *ngIf="result.table.loading" class="module-body flex-fill">
      Loading data...
    </app-module-progress>

    <div
      #tableScroll
      (scroll)="onTableScroll($event)"
      *ngIf="result.table.value"
      [scrollTop]="scrollTopAmount"
      class="flex-fill overflow-auto position-relative"
    >
      <div #findTarget class="table-container">
        <app-generic-table
          [entries]="result.table.value.tableCells"
          [header]="result.table.value.tableHeader"
          [object]="result.object.value"
        >
        </app-generic-table>
      </div>
    </div>

    <button (click)="scrollTop()" class="btn btn-secondary top-button">
      <i class="fa fa-arrow-up"></i> Top
    </button>
  </ng-container>
</div>
