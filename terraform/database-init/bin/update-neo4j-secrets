#!/bin/bash

# Copy the secret deployment environment file
gsutil cp gs://kg-secrets/deploy.env ./deploy.env

# Decrypt the secret file
gcloud kms decrypt --location global --keyring kg-secrets --key kg-secrets-key --ciphertext-file deploy.env --plaintext-file deploy.env.decrypted

# Replace with new database IP address
sed -i.bak -e "s/NEO4J_HOST=.*/NEO4J_HOST=${ipaddr}/g" deploy.env.decrypted

# Remove old env file and rename decrypted file
rm -rf deploy.env

# Encrypt the secret file
gcloud kms encrypt --location global --keyring kg-secrets --key kg-secrets-key --plaintext-file deploy.env.decrypted --ciphertext-file deploy.env

# Copy to google cloud bucket
gsutil cp ./deploy.env gs://kg-secrets/deploy.env

# Remove encrypted deploy.env
rm -rf deploy.env

echo "Secrets updated with new neo4j database address: ${ipaddr}"
