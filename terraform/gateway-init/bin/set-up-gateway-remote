#!/bin/bash

# Installs the dependencies for the VM to function
sleep 10
sudo apt-get update
sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
sudo apt-get update
sudo apt-get -y install docker-ce
sudo curl -L https://github.com/docker/compose/releases/download/1.25.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Run the initial test server to fetch certificates
sudo docker-compose -f /docker/letsencrypt-docker-nginx/src/letsencrypt/docker-compose.yml up -d

# Fetches the SSL certificates
sudo docker run --rm \
-v /docker-volumes/etc/letsencrypt:/etc/letsencrypt \
-v /docker-volumes/var/lib/letsencrypt:/var/lib/letsencrypt \
-v /docker/letsencrypt-docker-nginx/src/letsencrypt/letsencrypt-site:/data/letsencrypt \
-v /docker-volumes/var/log/letsencrypt:/var/log/letsencrypt \
certbot/certbot \
certonly --webroot \
--email dbour@eng.ucsd.edu --agree-tos --no-eff-email \
--webroot-path=/data/letsencrypt \
-d kg.lifelike.bio

# Stop the temporary server
sudo docker-compose -f /docker/letsencrypt-docker-nginx/src/letsencrypt/docker-compose.yml down

# Sets up the 2048 DH Params
sudo openssl dhparam -out /docker/letsencrypt-docker-nginx/src/production/dh-param/dhparam-2048.pem 2048

# Start up the server
sudo docker-compose -f /docker/letsencrypt-docker-nginx/src/production/docker-compose.yml up -d
